#!/usr/bin/env sh
. "$(dirname "$0")/_/husky.sh"

echo "ğŸ” Running pre-commit checks..."

# Check if we're in the backend directory or root
if [ -f "package.json" ] && [ -d "backend" ]; then
  echo "ğŸ“¦ Root project detected - running full checks"
  
  # Backend checks
  echo "ğŸ”§ Checking backend..."
  cd backend
  if [ -f "package.json" ]; then
    echo "  ğŸ“‹ Running backend linting..."
    npm run lint || { echo "âŒ Backend linting failed"; exit 1; }
    
    echo "  â­ï¸  Skipping backend build temporarily (images unblock)"
    echo "  âœ… Backend lint passed"
  fi
  cd ..
  
  # Frontend checks
  echo "ğŸ¨ Checking frontend..."
  cd frontend
  if [ -f "package.json" ]; then
    echo "  ğŸ“‹ Running frontend linting..."
    npm run lint || { echo "âŒ Frontend linting failed"; exit 1; }
    
    echo "  ğŸ—ï¸  Running frontend build..."
    npm run build || { echo "âŒ Frontend build failed"; exit 1; }
    
    echo "  âœ… Frontend checks passed"
  fi
  cd ..
  
elif [ -f "package.json" ]; then
  echo "ğŸ“¦ Single package detected - running checks"
  
  echo "ğŸ“‹ Running linting..."
  npm run lint || { echo "âŒ Linting failed"; exit 1; }
  
  echo "ğŸ—ï¸  Running build..."
  npm run build || { echo "âŒ Build failed"; exit 1; }
  
  echo "ğŸ§ª Running tests..."
  npm test || { echo "âŒ Tests failed"; exit 1; }
  
  echo "âœ… All checks passed"
else
  echo "âš ï¸  No package.json found, skipping checks"
fi

echo "ğŸ‰ Pre-commit checks completed successfully!"